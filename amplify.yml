version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            # Set location based on branch
            - |
              if [ "$AWS_BRANCH" = "lewiston" ]; then
                export NEXT_PUBLIC_LOCATION=location1
              elif [ "$AWS_BRANCH" = "brunswick" ]; then
                export NEXT_PUBLIC_LOCATION=location2
              elif [ "$AWS_BRANCH" = "gray" ]; then
                export NEXT_PUBLIC_LOCATION=location3
              fi
            # Let Amplify Gen 2 generate backend configuration automatically
            - echo "[Backend] Using Amplify Gen 2 auto-generated configuration"
            - cp amplify_outputs.json public/amplify_outputs.json
        build:
          commands:
            - echo "Building Next.js for $NEXT_PUBLIC_LOCATION"
            - npm run build
            - echo "Build completed. Checking output structure:"
            - ls -la .next/
        postBuild:
          commands:
            - chmod +x scripts/setup-waf-captcha.sh || true
            - ./scripts/setup-waf-captcha.sh || echo "[WAF] Skipped or failed; check permissions/environment"
            # Copy public assets and static files needed for standalone mode
            - cp -r public .next/standalone/ || echo "[Build] No public directory to copy"
            - cp -r .next/static .next/standalone/.next/ || echo "[Build] No static directory to copy"
      artifacts:
        baseDirectory: .next/standalone
        files:
          - "**/*"
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
