version: 1
applications:
  - backend:
      phases:
        preBuild:
          commands:
            - npm ci
        build:
          commands:
            - echo "Building for environment $AWS_BRANCH"
            # Set environment-specific variables based on branch
            - |
              if [ "$AWS_BRANCH" = "lewiston" ]; then
                export NEXT_PUBLIC_LOCATION=location1
              elif [ "$AWS_BRANCH" = "brunswick" ]; then
                export NEXT_PUBLIC_LOCATION=location2
              elif [ "$AWS_BRANCH" = "gray" ]; then
                export NEXT_PUBLIC_LOCATION=location3
              else
                export NEXT_PUBLIC_LOCATION=location1
              fi
            # Generate production backend configuration for each campus branch
            - |
              echo "[Backend] Generating production config for branch: $AWS_BRANCH"
              if [ "$AWS_BRANCH" = "gray" ]; then
                cat > amplify_outputs.json << 'EOL'
              {
                "auth": {
                  "user_pool_id": "us-east-1_XqeAJa9YW",
                  "aws_region": "us-east-1",
                  "user_pool_client_id": "4i3908r7f00n57gae6nvhttuj0",
                  "identity_pool_id": "us-east-1:51af273a-b309-488f-ba7d-3483f085cd35",
                  "mfa_methods": [],
                  "standard_required_attributes": ["email"],
                  "username_attributes": ["email"],
                  "user_verification_types": ["email"],
                  "mfa_configuration": "NONE",
                  "password_policy": {
                    "min_length": 8,
                    "require_lowercase": true,
                    "require_numbers": true,
                    "require_symbols": true,
                    "require_uppercase": true
                  },
                  "unauthenticated_identities_enabled": true
                },
                "data": {
                  "url": "https://s6n7b4p7djbgrdfek3adtxwvaa.appsync-api.us-east-1.amazonaws.com/graphql",
                  "aws_region": "us-east-1",
                  "api_key": "da2-oqndi7wn4jgjhjbr7kcazszfsa",
                  "default_authorization_type": "API_KEY",
                  "authorization_types": ["AMAZON_COGNITO_USER_POOLS", "AWS_IAM"]
                },
                "version": "1.4"
              }
              EOL
              else
                echo "[Backend] Using development/sandbox config for non-gray branches"
                cat > amplify_outputs.json << 'EOL'
              {
                "auth": {
                  "user_pool_id": "us-east-1_vwgchbYC8",
                  "aws_region": "us-east-1",
                  "user_pool_client_id": "1dsj6m1frqcp4lq23aeie2kaea",
                  "identity_pool_id": "us-east-1:ce2d84ed-1506-42b9-8394-2e402b5fd311",
                  "mfa_methods": [],
                  "standard_required_attributes": ["email"],
                  "username_attributes": ["email"],
                  "user_verification_types": ["email"],
                  "mfa_configuration": "NONE",
                  "password_policy": {
                    "min_length": 8,
                    "require_lowercase": true,
                    "require_numbers": true,
                    "require_symbols": true,
                    "require_uppercase": true
                  },
                  "unauthenticated_identities_enabled": true
                },
                "data": {
                  "url": "https://ps5sezumsvcmloznr4nryeodka.appsync-api.us-east-1.amazonaws.com/graphql",
                  "aws_region": "us-east-1",
                  "api_key": "da2-aiwlbul6rrhxflgxabtagr7kfa",
                  "default_authorization_type": "API_KEY",
                  "authorization_types": ["AMAZON_COGNITO_USER_POOLS", "AWS_IAM"]
                },
                "version": "1.4"
              }
              EOL
              fi
            - cp amplify_outputs.json public/amplify_outputs.json
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            # Set location based on branch
            - |
              if [ "$AWS_BRANCH" = "lewiston" ]; then
                export NEXT_PUBLIC_LOCATION=location1
              elif [ "$AWS_BRANCH" = "brunswick" ]; then
                export NEXT_PUBLIC_LOCATION=location2
              elif [ "$AWS_BRANCH" = "gray" ]; then
                export NEXT_PUBLIC_LOCATION=location3
              fi
        build:
          commands:
            - echo "Building frontend for $NEXT_PUBLIC_LOCATION"
            - npm run build
            - echo "Build completed. Checking output structure:"
            - ls -la
            - ls -la .next/ || echo "No .next directory"
        postBuild:
          commands:
            - chmod +x scripts/setup-waf-captcha.sh || true
            - ./scripts/setup-waf-captcha.sh || echo "[WAF] Skipped or failed; check permissions/environment"
      artifacts:
        baseDirectory: .
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    appRoot: .
