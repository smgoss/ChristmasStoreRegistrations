version: 1
applications:
  - appRoot: .
    frontend:
      environmentVariables:
        AMPLIFY_NODEJS_VERSION: '20'
        # Enable differential deploys for faster builds
        AMPLIFY_DIFF_DEPLOY: 'true'
        # Optimize npm for build performance
        NPM_CONFIG_CACHE: '/tmp/.npm'
        NPM_CONFIG_PREFER_OFFLINE: 'true'
        # Next.js optimizations
        NEXT_TELEMETRY_DISABLED: '1'
      phases:
        preBuild:
          commands:
            # Use npm ci with optimizations for faster installs
            - npm ci --cache /tmp/.npm --prefer-offline --no-audit --no-fund
            # Install function dependencies in parallel for speed
            - |
              (cd amplify/functions/create-admin-user && npm ci --cache /tmp/.npm --prefer-offline --no-audit --no-fund) &
              (cd amplify/functions/send-confirmation-email && npm ci --cache /tmp/.npm --prefer-offline --no-audit --no-fund) &
              (cd amplify/functions/send-sms-confirmation && npm ci --cache /tmp/.npm --prefer-offline --no-audit --no-fund) &
              (cd amplify/functions/send-invite-email && npm ci --cache /tmp/.npm --prefer-offline --no-audit --no-fund) &
              (cd amplify/functions/send-attendance-confirmation && npm ci --cache /tmp/.npm --prefer-offline --no-audit --no-fund) &
              (cd amplify/functions/reserve-registration && npm ci --cache /tmp/.npm --prefer-offline --no-audit --no-fund) &
              (cd amplify/functions/auto-close-registration && npm ci --cache /tmp/.npm --prefer-offline --no-audit --no-fund) &
              wait
            # Set location based on branch
            - |
              if [ "$AWS_BRANCH" = "lewiston" ]; then
                export NEXT_PUBLIC_LOCATION=location1
              elif [ "$AWS_BRANCH" = "brunswick" ]; then
                export NEXT_PUBLIC_LOCATION=location2
              elif [ "$AWS_BRANCH" = "gray" ]; then
                export NEXT_PUBLIC_LOCATION=location3
              fi
               npx ampx pipeline-deploy --debug true --branch $AWS_BRANCH --app-id $AWS_APP_ID
        build:
          commands:
            - echo "Checking if amplify_outputs.json was generated..."
            - ls -la amplify_outputs.json || echo "No amplify_outputs.json found in root"
            - echo "Copying amplify_outputs.json to public directory if it exists..."
            - cp amplify_outputs.json public/amplify_outputs.json || echo "Could not copy amplify_outputs.json - this is expected if backend hasn't deployed yet"
            - npm run build
        postBuild:
          commands:
            - chmod +x scripts/setup-waf-captcha.sh || true
            - ./scripts/setup-waf-captcha.sh || echo "[WAF] Skipped or failed; check permissions/environment"
      artifacts:
        baseDirectory: .next
        files:
          - "**/*"
      cache:
        paths:
          # Main app dependencies and build cache
          - node_modules/**/*
          - .next/cache/**/*
          - /tmp/.npm/**/*
          # Function dependencies cache
          - amplify/functions/*/node_modules/**/*
          # TypeScript incremental cache
          - .tsbuildinfo
          # ESLint cache
          - .eslintcache
