version: 1
applications:
  - backend:
      phases:
        preBuild:
          commands:
            - npm ci
        build:
          commands:
            - echo "Building for environment $AWS_BRANCH"
            # Set environment-specific variables based on branch
            - |
              if [ "$AWS_BRANCH" = "lewiston" ]; then
                export NEXT_PUBLIC_LOCATION=location1
              elif [ "$AWS_BRANCH" = "brunswick" ]; then
                export NEXT_PUBLIC_LOCATION=location2
              elif [ "$AWS_BRANCH" = "gray" ]; then
                export NEXT_PUBLIC_LOCATION=location3
              else
                export NEXT_PUBLIC_LOCATION=location1
              fi
            # Skip backend deployment - use sandbox/local development only
            # Production backend resources should be deployed separately via AWS CLI/CDK
            - echo "Backend deployment skipped - use local sandbox for development"
            # Generate mock outputs for frontend build
            - echo '{"version":"1","auth":{"user_pool_id":"mock","user_pool_client_id":"mock","identity_pool_id":"mock","aws_region":"us-east-1"}}' > amplify_outputs.json
            - cp amplify_outputs.json public/amplify_outputs.json
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            # Set location based on branch
            - |
              if [ "$AWS_BRANCH" = "lewiston" ]; then
                export NEXT_PUBLIC_LOCATION=location1
              elif [ "$AWS_BRANCH" = "brunswick" ]; then
                export NEXT_PUBLIC_LOCATION=location2
              elif [ "$AWS_BRANCH" = "gray" ]; then
                export NEXT_PUBLIC_LOCATION=location3
              fi
        build:
          commands:
            - echo "Building frontend for $NEXT_PUBLIC_LOCATION"
            - npm run build
        postBuild:
          commands:
            - chmod +x scripts/setup-waf-captcha.sh || true
            - ./scripts/setup-waf-captcha.sh || echo "[WAF] Skipped or failed; check permissions/environment"
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    appRoot: .
